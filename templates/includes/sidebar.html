<nav x-data="{
    expanded: localStorage.getItem('sidebarExpanded') === 'true',
    
    init() {
        // Keyboard shortcut listener
        window.addEventListener('keydown', (e) => {
            if (e.key === '`' || e.key === '~') {
                this.toggleSidebar();
                e.preventDefault();
            }
        });
        
        // Watch for changes and save to localStorage
        this.$watch('expanded', (value) => {
            localStorage.setItem('sidebarExpanded', value);
        });
    },
    
    toggleSidebar() {
        this.expanded = !this.expanded;
    }
}" 
class="sticky top-0 h-screen p-[10px] pr-0 shadow border-r border-[var(--border-color)] min-w-[64px] backdrop-blur-[90px] z-50"
:class="{
    'w-[60px] duration-300': !expanded, 
    'w-[180px] duration-300 ease-out': expanded
}">
    
    <div class="flex flex-col justify-between h-full items-start">
        <a class="flex gap-2 items-center justify-center hover:opacity-70" href="/">
            <div class="w-[40px] h-[40px] flex items-center justify-center">
                <img class="h-full w-full" src="/static/images/logo.svg" alt="Logo"/>
            </div>
            <span class="text-xl font-semibold"
                x-show="expanded" 
                x-transition:enter="transition ease-out duration-300 opacity-100"
                x-transition:leave="transition ease-in duration-300 opacity-0">
                Name
            </span>
        </a>

        <div class="flex flex-col gap-6 text-xl">
            <!-- Home -->
            <a href="{% url 'home' %}" 
                class="flex items-center gap-2 opacity-60 hover:opacity-80 {% if request.path == '/' or request.path == '/home/' %}!opacity-100 font-bold{% endif %}">
                <div class="w-[40px] h-[40px] flex items-center justify-center">
                    <i class="material-symbols-outlined text-4xl {% if request.path == '/' or request.path == '/home/' %}filled{% endif %}">home</i>
                </div>
                <div x-show="expanded" x-transition:enter="transition ease-out duration-300 opacity-100" x-transition:leave="opacity-0 transition ease-in duration-300">
                    Home
                </div>
            </a>
        
            <!-- Profile -->
            <a href="{% url 'profile' %}" 
                class="flex items-center gap-2 opacity-60 hover:opacity-80 {% if request.path|slice:':8' == '/profile' %}!opacity-100 font-bold{% endif %}">
                <div class="w-[40px] h-[40px] flex items-center justify-center">
                    <i class="material-symbols-outlined text-4xl {% if request.path|slice:':8' == '/profile' %}filled{% endif %}">person</i>
                </div>
                <div x-show="expanded" x-transition:enter="transition ease-out duration-300 opacity-100" x-transition:leave="opacity-0 transition ease-in duration-300">
                    Profile
                </div>
            </a>
        </div>
        
        <!-- Sidebar Items -->
        <div class="relative navitems flex flex-col items-center">
            
            {% if request.user.is_authenticated %}
            <!-- Expand Button -->
            <button @click="expanded = !expanded" class="flex items-center justify-center w-full h-10 rounded-full transition-transform" :class="{'rotate-180': expanded}">
                <i class="material-symbols-outlined opacity-60 text-sm">arrow_forward_ios</i>
            </button>

            <div x-data="{ dropdownOpen: false, showThemeToggle: false }">
                <!-- Avatar click toggles dropdown, but closes theme toggle -->
                <a class="h-[40px] w-[40px] flex items-center justify-center cursor-pointer select-none" 
                   @click="dropdownOpen = !dropdownOpen; showThemeToggle = false" 
                   @click.away="dropdownOpen = false; showThemeToggle = false">
                    <img class="h-[32px] w-[32px] avatar-header" src="{{user.profile.avatarDisplay}}"/>
                </a>
            
                <!-- Dropdown menu: only show when dropdownOpen and NOT showThemeToggle -->
                <div x-show="dropdownOpen && !showThemeToggle" x-cloak 
                    @click.stop 
                    class="absolute bottom-4 left-4 min-w-[180px] z-90 dropdown-menu shadow-4xl"
                    x-transition:enter="duration-200 ease"
                    x-transition:enter-start="opacity-0 -translate-x-2 translate-y-2 scale-20"
                    x-transition:enter-end="opacity-100 scale-100"
                    x-transition:leave="duration-100 ease-in"
                    x-transition:leave-start="opacity-100 scale-100"
                    x-transition:leave-end="opacity-0 -translate-x-2 translate-y-2 scale-20">
                    <a href="{% url 'account_logout' %}" class="text-red-500">Log Out</a>
                    <a href="{% url 'profile' %}">My Profile</a>
                    <a href="{% url 'settings' %}">Settings</a>
            
                    <!-- Appearance toggle -->
                    <a id="show-theme-toggle" 
                       @click="showThemeToggle = true"
                       class="flex items-center justify-between cursor-pointer">
                        Appearance 
                        <i class="material-symbols-outlined opacity-60 text-sm">arrow_forward_ios</i>
                    </a>
                </div>
            
                <!-- Theme Toggle panel -->
                <div x-show="showThemeToggle"
                    x-cloak
                    x-transition:enter="transition ease-out duration-300"
                    x-transition:enter-start="opacity-0 scale-90"
                    x-transition:enter-end="opacity-100 scale-100"
                    x-transition:leave="transition ease-out duration-150"
                    x-transition:leave-start="opacity-100 scale-100"
                    x-transition:leave-end="opacity-0 scale-90"
                    class="absolute bottom-4 left-4 border-4 min-w-[300px] z-90 dropdown-menu shadow-4xl rounded-xl"
                    @click.stop
                    @click.away="showThemeToggle = false">
                    {% include 'partials/theme_toggle.html' %}
                </div>
            </div>
            
            {% else %}
            <!-- Settings -->
            <a href="{% url 'settings' %}" 
                class="flex items-center gap-2 opacity-60 hover:opacity-80 {% if '/settings' in request.path %}!opacity-100 font-bold{% endif %}">
                <div class="w-[40px] h-[40px] flex items-center justify-center">
                    <i class="material-symbols-outlined text-2xl {% if '/settings' in request.path %}filled{% endif %}">settings</i>
                </div>
                <div x-show="expanded" x-transition:enter="transition ease-out duration-300 opacity-100" x-transition:leave="opacity-0 transition ease-in duration-300">
                    Settings
                </div>
            </a>
            <!-- <a class="a font-bold" href="{% url 'account_login' %}">Login</a>
            <a class="a font-bold" href="{% url 'account_signup' %}">Register</a> -->
            {% endif %}
        </div>
    </div>
</nav>
